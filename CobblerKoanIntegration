== Goal ==

Why should we integrate cobbler into Spacewalk:

 * Keeping our virt stuff updated: 
  * xen installs using virtinst library (same as virt manager), remove legacy Xen-specific code
  * qemu/KVM
  * vmware installs (evolving)
  * lvm backed guests
  * multiple disks for VMs
  * multiple NICs for VMs
 * Other OS support: 
  * First class:
   * Fedora
   * CentOS 
  * Second class (no repo support, kickstart templating and PXE still works)
   * Debian / Ubuntu
   * SuSE
 * Additional rollout options
  * auto-managed PXE tree with auto-generated/auto-updated menus: Ability to reinstall hardware via PXE (do not need "good" OS)
 * LiveCD/DeadCD support for bare metal rollout where customer has no PXE
 * DHCP and DNS management
 * Templating of our files (especially kickstarts) -- less kickstarts to manage
 * able to do bare-metal deployments on multiple subnets
 * replication between Cobbler servers (multi-datacenter) (evolving)
 * integrated image replication/cloning (future?) for Windows/other environs
 * power management (future?)
 * for more see: https://fedorahosted.org/cobbler

== Requirements ==

1. Installation of Spacewalk will include an installation of Cobbler

1.1  The spacewalk-setup program will configure Cobbler to work with Spacewalk

2. Cobbler will be able to be invoked from the command line on the Spacewalk server

3. Clients with koan installed will be able to be invoked against the Spacewalk server:
   
  {{{koan --virt --profile=f9-xen-i386 --nogfx --server=spacewalk.example.com --virt-name=test-f9}}}

4. Cobbler and koan CLI and server (but not Cobbler WUI) will be supported by Red Hat once this feature is available within a Satellite release.  --TBD

5. Spacewalk will synchronize creation/updates/deletes to each Kickstart Profile with a Cobbler profile

5.1. Changes to Cobbler profiles from the cobbler CLI will be synchronized to the Spacewalk Kickstart Profiles

6. Cobbler will fetch Kickstart files from Spacewalk

 -- upgrade path? 

7. Systems using Cobbler and Koan for provisioning will consume a Provisioning entitlement upon registration to the Spacewalk server.

8. A Spacewalk server will be supported and able to function as a PXE server for use with Provisioning if so configured. 

8.1. A Spacewalk server will be be supported able to function as a DHCP/DNS server for use with Provisioning if so configured. 

8.2 The spacewalk-setup 
 
 -- do we need a webui for this?
 -- 

9. Cobbler will be able to use the Kickstart Profiles contained within Spacewalk to provide to Anaconda.

10. Spacewalk will offer a new advanced Kickstart GUI page that will allow a user to hand-edit the kickstart file and send it down to Cobbler for synchronization.

11. Spacewalk's virtualization provisioning feature will utilize Cobbler and Koan to create new virtual guests.

12. Spacewalk's virtualization provisioning feature will be expanded to include more options to include LVM backed guest options, qeumu and KVM options, multiple NICs per VM and multiple disks for VMs.

13. Spacewalk will be able to provision CentOS and Fedora virtual and non virtual machines.

== RHN Satellite Specific Requirements  ==

1. Cobbler will be shipped in the rhn-satellite channel -- TBD

2. Koan will be shipped in the rhn-tools channels -- TBD

3. Satellite upgrades --> sync all existing ks profiles to cobbler

4. Satellite will only support provisioning and virtualization management features that are supported in Red Hat Enterprise Linux.

== Specification ==

=== Command Line ===

We want to allow users to continue to use Cobbler's CLI from the server side.
In other words, edits from WebUI should not mean CLI usage is disallowed, i.e. CLI has more "knobs" exposed.
Spacewalk can be "read-modify-write" into Cobbler DB using Cobbler API calls.

=== Content ===

 * Make cobbler know how to represent a repository that it is not mirroring (DONE -- mpd)
 * yum-rhn-plugin - (??? what does this mean -- mpd )

=== Client ===
 * calling out to koan from rhnlib
 * kickstart progress monitoring?
  * cobbler has some monitoring via a post-install trigger.  Can we leverage that? -- mpd

=== Server ===
 * cobbler server running on Spacewalk
  * installer should configure /etc/cobbler/settings, /etc/cobbler/modules.conf
 * synchronization of Spacewalk Kickstart Profiles into Cobbler Profiles
 * synchronization of Cobbler profiles into Spacewalk Kickstart Profiles

=== Things we need from cobbler ===
 * virt provision time system overrides
  * Basically Spacewalk sets virt-ram on a system-by-system basis, where as Cobbler prefered profile-by-profile.  Easy enough to add.
  * DONE -- mpd
 * Ability to block for virt installs 
  * post-install trigger for success/registration may be enough?
  * perhaps we can make rhnreg_ks be smart enough to be this? 
 * xmlrpc api vs python lib direct 
  * Cobbler is written in it's own API (api.py), remote.py offers 90% functionality, might need some extensions
 * need to verify koan --replace-self is happy on RHEL3 (it's supposed to be), and also make it work on RHEL2.1

=== Phase I (prototype/investigation) ===

Investigation phase:

 * get rhn client talking to koan to initiate virt installs and re-installs
 * setup action types and ability for Spacewalk to schedule reinstalls and virt installs.
 * write API so we can schedule cobbler style installs
 * get cobbler running on a Spacewalk
 * use xmlrpc to utilize above setup to test doing a cobbler KS from Spacewalk


=== Phase II (real integration) ===

 * Integrate Spacewalk's Kickstart UI with cobbler:  Keep our existing database tables but keep our Kickstart Profiles in sync with cobbler.  CRUD operations will trickle down to cobbler
  * I think we can likely construct a Spacewalk "wizard.ks" template for using Cobbler to generate the existing Spacewalk profiles into Cobbler form, but we want to explore that further...  Cobbler uses Cheetah for templating which essentially allows for anything Pythonic to be included.
 * Offer GUI with 'advanced' option to show a textbox with existing rendering of Spacewalk's Kickstart profile that can be edited then stored down into cobbler.
 * replace client side kickstart and virtualization code with full integration with cobbler vs the rhn-kickstart and rhn-kickstart-vitualization packages.

=== Phase III (replacement of Spacewalk's kickstart persistence) ===

Phase III is where we build on the work from the previous phases to fully integrate and replace Spacewalk's kickstart/virt code with cobbler/koan.  This Phase will be evaluated as necessary or not depending on the success of the previous Phases.

 * Remove Spacewalk's rhnKickstart* database representation of the kickstart profile.  Move to storing it all in cobbler
 * Build advanced GUI to expose all of what Cobbler can do within our GUI (livecd, pxe, etc..).
  * Note: I think we get the live CD and PXE menus for free in phase II. (mpd)

=== Potentially most interesting things to thing about for Phase III ===

(from mdehaan)

 * Getting Spacewalk to manage DHCP and BIND entries for new systems (optional)
 * Fedora and CentOS support (including ability to rsync the trees in cobbler)
 * KVM
 * LVM backed virtual guests
 * Expose the "netboot-enabled flag" and look into integrating power management


== Estimates ==

||  '''Task''' || '''Target Release''' ||  '''Estimate (days)''' || '''Developer''' || '''Status''' || '''Notes''' ||
||  ----   ||  ||  ||  ||  ||  ||
||  Installer: Modify spacewalk rpm to depend on cobbler || 0.3 || 1 || paji ||  ||  ||
||  Installer: Modify installer to configure Cobbler || 0.3 || 2 || paji ||  ||  ||
||  ----   ||  ||  ||  ||  ||  ||
||  Koan: Verify and test koan clients calling cobbler on spacewalk server || 0.4 || 2 || mmccune ||  ||  ||
||  ----   ||  ||  ||  ||  ||  ||
||  Synchronization: Develop method for Spacewalk server calling Cobbler (xmlrpc) || 0.4 || 3 || paji ||  ||  ||
||  Synchronization: Develop method for Cobbler calling Spacewalk (xmlrpc) || 0.4 || 3 || paji ||  ||  ||
||  Synchronization: Kickstart Profile creation in Spacewalk creates cobbler profile || 0.4 || 5 || paji ||  ||  ||
||  Synchronization: Kickstart Profile edit in Spacewalk edits cobbler profile || 0.4 || 5 || paji ||  ||  ||
||  Synchronization: Kickstart Profile delete in Spacewalk deletes cobbler profile || 0.4 || 1 || paji ||  ||  ||
||  Synchronization: Kickstart Distribution creation in Spacewalk creates cobbler profile || 0.4 || 5 || paji ||  ||  ||
||  Synchronization: Kickstart Distribution edit in Spacewalk edits cobbler profile || 0.4 || 5 || paji ||  ||  ||
||  Synchronization: Kickstart Distribution delete in Spacewalk deletes cobbler profile || 0.4 || 1 || paji ||  ||  ||
||  Synchronization: Cobbler Profile creation creates Spacewalk Kickstart profile || 0.4 || 5 || paji ||  ||  ||
||  Synchronization: Cobbler Profile edit edits Spacewalk Kickstart Profile  || 0.4 || 2 || paji ||  ||  ||
||  Synchronization: Cobbler Profile delete in Spacewalk deletes cobbler profile || 0.4 || 1 || paji ||  ||  ||
||  Synchronization: Cobbler Distribution creation creates Spacewalk Kickstart Profile || 0.4 || 2 || paji ||  ||  ||
||  Synchronization: Cobbler Distribution edits Spacewalk Kickstart Profile  || 0.4 || 2 || paji ||  ||  ||
||  Synchronization: Cobbler Distribution delete Spacewalk Kickstart Profile || 0.4 || 1 || paji ||  ||  ||
||  ----   ||  ||  ||  ||  ||  ||
||  Upgrades: All pre-existing Kickstart Profiles/Distributions will be populated into Cobbler upon upgrade from Satellite 5.1.0 or earlier. || 0.4 || 5 || paji ||  ||  ||
||  ----   ||  ||  ||  ||  ||  ||
||  Kickstarts: Remove tinyurl usage from Spacewalk   . || 0.4 || 3 || mmccune ||  ||  ||
||  Kickstarts: Document how to use Spacewalk content for kickstarting without need for tinyurl. || 0.4 || 1 || mmccune ||  ||  ||
||  Kickstarts: Port remaining Perl Kickstart Sniglet handlers || 0.4 || 4 || mmccune ||  ||  ||
||  ----   ||  ||  ||  ||  ||  ||
||  Cobbler: All Cobbler Profiles created by Spacewalk KS GUI/API will be setup to fetch their kickstart.cfg files from Spacewalk  . || 0.4 || 3 || paji ||  ||  ||
||  Cobbler: Manually setup Cobbler as PXE server on spacewalk . || 0.4 || 3 || TBD ||  ||  ||
||  Cobbler: Manually setup Cobbler as DHCP server on spacewalk . || 0.4 || 3 || TBD ||  ||  ||
||  ----   ||  ||  ||  ||  ||  ||
||  GUI: Build GUI in Spacewalk Tools to configure Spacewalk as PXE server || 0.4 || 3 || paji ||  ||  ||
||  GUI: Build GUI in Spacewalk Tools to configure Spacewalk as DHCP server || 0.4 || 3 || paji ||  ||  ||
||  GUI: Modify Kickstart Profile creation to have option for 'advanced' mode where user pastes in their own kickstart.cfg file || 0.4 || 5 || mmccune ||  ||  ||
||  GUI: Build input form for manual paste of kickstart.cfg || 0.4 || 5 || mmccune ||  ||  ||
||  ----   ||  ||  ||  ||  ||  ||
||  Database: Modify rhnKSData and associated tables to be able to store an actual file || 0.4 || 3 || mmccune ||  ||  ||
||  Backend: Verify modification to rhnKSData and associated tables will not effect backend code || 0.4 || 3 || mmccune ||  ||  ||
||  API: Modify kickstart.importFile to use new database storage mechanism || 0.4 || 3 || mmccune ||  ||  ||
||  Kickstart File Render: Kickstart rendering to support new 'advanced' mode || 0.4 || 3 || mmccune ||  ||  ||
||  ----   ||  ||  ||  ||  ||  ||
||  Entitlements: One-time Activation Keys created for a Kickstart Session will automatically have a Provisioning Entitlement added to them || 0.4 || 1 || mmccune ||  ||  ||
||  ----   ||  ||  ||  ||  ||  ||
||  Virtualization: Database modifications to offer more virtualization options for a Kickstart Profile (disk, cpu, lvm, etc..) || 0.4 || 2 || mmccune ||  ||  ||
||  Virtualization: GUI to support new virtualization options for Kickstart Profiles || 0.4 || 3 || mmccune ||  ||  ||
||  Virtualization: Provisioning displaying expanded options list for guest creation and allowing overrides || 0.4 || 3 || mmccune ||  ||  ||

'''Total Days: ~105'''

== Non-Cobbler But Slightly Related Interesting Things ==

 * put Virt-viewer applet in Spacewalk virt UI (something we wanted to do in VF at one point)

== Random technical notes ==

 * when looking at cobbler, you are most interested in the devel branch ATM (no longer really applies, I'd code against master -- mpd)
 * Cobbler's command line is written against the Cobbler api, see "api.py"
 * Cobbler's WUI is written against it's XMLRPC API, as is koan, see ""remote.py" -- for examples "remote.py", "services.py"
 * probably best to use the XMLRPC API to allow for maximum cross-language support
 * multiple authentication options to webui, simplest is creating a key in a digest file, also does kerberos/LDAP.
 * for example of misc. cobbler triggers, templating examples, kickstart snippets, and other customization, see the Cobbler Wiki

== Installation Issues =

 * Cobbler uses /etc/httpd/conf.d/cobbler.conf and we are using /etc/httpd/conf configs that need to be linked together
 * This means requests to http://host.example.com/cobbler/ will 404


== Notes from June 26 ==

 * Consensus:  Most important/interesting features to add first are:

    * Baremetal deployment: whole lot of rhel, very fast.  DNS/DHCP
    * Do we care about other virt types: xen-full virt support.  PXE support: rhel cant do it (yet).  KVM, rhel can't do it.  LVM backed virt storage.
    * Are we going to provide a way to configure and turn on baremetal DHCP and/or DNS support in the GUI?
       * or does the installer just ask this question while generating /etc/cobbler/settings  and /etc/cobbler/modules.conf ?
    * Build ISO stuff

