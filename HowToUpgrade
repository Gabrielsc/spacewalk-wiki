= Spacewalk Upgrade Instructions =

Spacewalk upgrade from version 0.4 to 0.5 involves several basic steps:
  1.  Configuration files and Spacewalk database backup
  2.  Update of Jabber SSL certificate location
  3.  Package upgrade
  4.  Schema upgrade
  5.  Upgrade of Spacewalk configuration
  6.  Disable jabberd and osa-dispatcher services
  7.  Update Spacewalk configuration files
  8.  Restart Spacewalk
  9.  Rebuild search indexes

----


= Assumptions =

  * For RHEL or CentOS, you will need the Base, EPEL and EPEL testing repositories enabled for dependencies. EPEL testing currently provides cobbler ver. 1.6.1 required by Spacewalk 0.5.


=  Database and configuration backup  =


  *  For existing configuration files, create a backup of everything under /etc/sysconfig/rhn /etc/rhn and /etc/jabberd
  *  For instructions on how to create a backup of your existing Spacewalk database consult either Oracle documentation or contact your DBA


= Update of Jabber SSL certificate location =

With jabberd-2.2.5 package present in EPEL, it is necessary to update location of SSL certificate used by jabberd service: /etc/jabberd/server.pem
This change is required to avoid file conflict that would otherwise occur during package upgrade: the PEM file in question is owned by both
new jabberd from EPEL and another package from your earlier Spacewalk installation created at setup time 
(by spacewalk-setup / rhn-ssl-tool).

To update the location, follow these steps: 

Setup your yum configuration to point to Spacewalk 0.5 repo:

{{{
[spacewalk]
name=Spacewalk
baseurl=http://spacewalk.redhat.com/yum/0.5/RHEL/5/$basearch/os
gpgkey=http://spacewalk.redhat.com/yum/RPM-GPG-KEY-spacewalk
enabled=1
gpgcheck=1
}}}

Stop your Spacewalk server. To accomplish this, execute following command as root:

{{{
# /usr/sbin/rhn-satellite stop
}}}

Update spacewalk-certs-tools package:

{{{
# yum upgrade spacewalk-certs-tools
}}}


As root, run upgrade-cert.sh script attached to this page:
{{{
# ./upgrade-certs.sh
}}}

This script will try to re-create new rpm package containing your original SSL certificates with server.pem file put
into a new location and instruct you to do these additional steps:

  *  Uninstall original package containing your certificate files

  *  Install updated package with your original certificate files

  *  Create a backup of rpm files that were created

  *  Remove temporary content created in previous steps.

= Package upgrade =

Perform package upgrade using yum:

{{{
# yum upgrade
}}}

During the upgrade, you may notice messages printed to the terminal when installing oracle-instantclient-selinux and spacewalk-selinux.
These messages are produced by restorecon and do not pose any harm.
On the contrary, these messages indicate relabeling of file system objects that is required for correct Spacewalk and SELinux symbiosis.

=  Schema upgrade  =

Make sure your Spacewalk server is down:

{{{
# /usr/sbin/rhn-satellite status
}}}

Make sure your oracle server is running. For oracle-xe that would be:

{{{
# service oracle-xe status
}}}

Run spacewalk-schema-upgrade script to upgrade database schema:

{{{
# /usr/bin/spacewalk-schema-upgrade
}}}


Log files from schema upgrade are being put into /var/log/spacewalk/schema-upgrade


=  Upgrade of Spacewalk configuration  =

For Spacewalk 0.5, it is required to deploy configuration for cobbler and update configuration of apache SSL virtual host. Both steps can be accomplished by running:

{{{
# spacewalk-setup --disconnected --upgrade
}}}

You'll be asked by spacewalk-setup to provide your database connection information. Following this spacewalk-setup will ask you whether you wish to
have your apache ssl configuration (/etc/httpd/conf.d/ssl.conf) updated by spacewalk-setup. You may choose to setup your ssl.conf manually, in which
case you have to make sure you have the following directives present in your /etc/httpd/conf.d/ssl.conf:

{{{
# cat /etc/httpd/conf.d/ssl.conf
...
<VirtualHost _default_:443>
...
SSLCertificateFile /etc/pki/tls/certs/spacewalk.crt
SSLCertificateKeyFile /etc/pki/tls/private/spacewalk.key
RewriteEngine on
RewriteOptions inherit
SSLProxyEngine on
...
</VirtualHost>
...
}}}


= Disable jabberd and osa-dispatcher services =

jabberd-2.2 is known not to work correctly with Spacewalk 0.5 and RHEL-5 / CentOS-5 and it is highly recommended to disable jabberd and osa-dispatcher
services after Spacewalk upgrade:

{{{
# chkconfig osa-dispatcher off
# chkconfig jabberd off
}}}


= Update Spacewalk configuration files =

Restore some of the custom values you might have set previously in /etc/rhn/rhn.conf from the backup of your configuration files, such as:

  *  debug = 3
  *  pam_auth_service = rhn-satellite
  *  default_db = user/password@sid

=  Restart Spacewalk  =

If all of the above steps completed successfully, you can start your upgraded Spacewalk server. With Spacewalk 0.3, rhn-satellite init script
was decommissioned and all Spacewalk services are being started individually. If you need to restart your Spacewalk using one command,
use /usr/sbin/rhn-satellite script.

{{{
# /usr/sbin/rhn-satellite start
}}}

During the start, you will likely see a glibc exception printed out to the console caused by a jabberd misconfiguration. This
is a known issue and it is recommended to stop jabberd and osa-dispatcher services afterwards.

= Rebuild search indexes =

After a successful upgrade, it is recommended to rebuild search indexes used by Spacewalk search engine (rhn-search service).
This can be accomplished by following steps:

{{{
# /etc/init.d/rhn-search cleanindex
# /etc/init.d/rhn-search start
}}} 

----
What's bellow are additional steps that were required for Spacewalk 0.2 to Spacewalk 0.3 upgrades. These steps are no longer required for
Spacewalk 0.4 to Spacewalk 0.5 upgrades and can be safely ignored.

=  Activate Spacewalk services  =

With release of 0.3, spacewalk services (rhn-search, satellite-httpd, taskomatic, ...) are no longer started from /etc/init.d/rhn-satellite,
every service has its own init.d script with chkconfig entries.

When doing a new Spacewalk 0.3 installation, all the services are being activated by spacewalk-setup. When upgrading existing Spacewalk 0.2
installation, you have to activate all these services manually:

{{{
# for service in jabberd osa-dispatcher taskomatic tomcat5 satellite-httpd Monitoring MonitoringScout rhn-search; do
    if [ -e "/etc/init.d/$service" ]; then
        /sbin/chkconfig --level 345 $service on
    fi
done
}}}


---

What's bellow are additional steps that were required for Spacewalk 0.1 to Spacewalk 0.2 upgrades. These steps are no longer required for
Spacewalk 0.2 to Spacewalk 0.3 upgrades and can be safely ignored.

=  Package paths upgrade =

Spacewalk ver. 0.2 introduced new layout of /var/satellite directory (change coming with multiple distribution support). To migrate
existing packages into new locations, use update-packages script (spacewalk-backend-satellite-tools) with a valid database connection string.

{{{
# /usr/bin/update-packages --db=spacewalk/spacewalk@xe
}}}


=  Update configuration  =


If you're upgrading Spacewalk 0.1 to version 0.2, add the following line into /etc/rhn/rhn.conf and /etc/rhn/default/rhn_web.conf:


{{{
web.product_name = Spacewalk
}}}