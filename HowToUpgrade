= Spacewalk Upgrade Instructions =

Spacewalk upgrade from version 0.3 to 0.4 involves several basic steps:
  1.  Configuration files and Spacewalk database backup
  2.  Package upgrade
  3.  Schema upgrade
  4.  Upgrade of Spacewalk configuration
  5.  Restart Spacewalk

----


= Assumptions =

  * For RHEL or CentOS, you will need the Base, EPEL and EPEL testing repositories enabled for dependencies. EPEL testing currently provides cobbler ver. 1.4 required by Spacewalk 0.4.


=  Database and configuration backup  =


  *  For existing configuration files, create a backup of everything under /etc/sysconfig/rhn/ and /etc/rhn/
  *  For instructions on how to create a backup of your existing Spacewalk database consult either Oracle documentation or contact your DBA


= Package upgrade =

Setup your yum configuration to point to Spacewalk 0.4 repo:

{{{
[spacewalk]
name=Spacewalk
baseurl=http://spacewalk.redhat.com/yum/0.4/rhel/5Server/$basearch/
gpgkey=http://spacewalk.redhat.com/yum/RPM-GPG-KEY-spacewalk
enabled=1
gpgcheck=1
}}}

Stop your Spacewalk server. To accomplish this, execute following command as root:

{{{
# /sbin/rhn-satellite stop
}}}

Perform package upgrade using yum:

{{{
# yum upgrade
}}}

During the upgrade, you may notice messages printed to the terminal when installing oracle-instantclient-selinux and spacewalk-selinux.
These messages are produced by restorecon and do not pose any harm.
On the contrary, these messages indicate relabeling of file system objects that is required for correct Spacewalk and SELinux symbiosis.

=  Schema upgrade  =

Make sure your Spacewalk server is down (note that /sbin/rhn-satellite moved to /usr/sbin/rhn-satellite between upgraded versions):

{{{
# /usr/sbin/rhn-satellite status
}}}

Make sure your oracle server is running. For oracle-xe that would be:

{{{
# service oracle-xe status
}}}

Run spacewalk-schema-upgrade script to upgrade database schema:

{{{
# /usr/bin/spacewalk-schema-upgrade
}}}


Log files from schema upgrade are being put into /var/log/spacewalk/schema-upgrade


=  Upgrade of Spacewalk configuration  =

For Spacewalk 0.4, it is required to deploy configuration for cobbler and update configuration of apache SSL virtual host. Both steps can be accomplished by 
running:

{{{
# spacewalk-setup --disconnected --upgrade
}}}

You'll be asked by spacewalk-setup to provide your database connection information. Following this spacewalk-setup will ask you whether you wish to
have your apache ssl configuration (/etc/httpd/conf.d/ssl.conf) updated by spacewalk-setup. You may choose to setup your ssl.conf manually, in which
case you have to make sure you have the following directives present in your /etc/httpd/conf.d/ssl.conf:

{{{
# cat /etc/httpd/conf.d/ssl.conf
...
<VirtualHost _default_:443>
...
SSLCertificateFile /etc/pki/tls/certs/spacewalk.crt
SSLCertificateKeyFile /etc/pki/tls/private/spacewalk.key
RewriteEngine on
RewriteOptions inherit
SSLProxyEngine on
...
</VirtualHost>
...
}}}


=  Restart Spacewalk  =

If all of the above steps completed successfully, you can start your upgraded Spacewalk server. With Spacewalk 0.3, rhn-satellite init script
was decommissioned and all Spacewalk services are being started individually. If you need to restart your Spacewalk using one command,
use /usr/sbin/rhn-satellite script.

{{{
# /usr/sbin/rhn-satellite start
}}}


----
What's bellow are additional steps that were required for Spacewalk 0.2 to Spacewalk 0.3 upgrades. These steps are no longer required for
Spacewalk 0.3 to Spacewalk 0.4 upgrades and can be safely ignored.

=  Activate Spacewalk services  =

With release of 0.3, spacewalk services (rhn-search, satellite-httpd, taskomatic, ...) are no longer started from /etc/init.d/rhn-satellite,
every service has its own init.d script with chkconfig entries.

When doing a new Spacewalk 0.3 installation, all the services are being activated by spacewalk-setup. When upgrading existing Spacewalk 0.2
installation, you have to activate all these services manually:

{{{
# for service in jabberd osa-dispatcher taskomatic tomcat5 satellite-httpd Monitoring MonitoringScout rhn-search; do
    if [ -e "/etc/init.d/$service" ]; then
        /sbin/chkconfig --level 345 $service on
    fi
done
}}}


---

What's bellow are additional steps that were required for Spacewalk 0.1 to Spacewalk 0.2 upgrades. These steps are no longer required for
Spacewalk 0.2 to Spacewalk 0.3 upgrades and can be safely ignored.

=  Package paths upgrade =

Spacewalk ver. 0.2 introduced new layout of /var/satellite directory (change coming with multiple distribution support). To migrate
existing packages into new locations, use update-packages script (spacewalk-backend-satellite-tools) with a valid database connection string.

{{{
# /usr/bin/update-packages --db=spacewalk/spacewalk@xe
}}}


=  Update configuration  =


If you're upgrading Spacewalk 0.1 to version 0.2, add the following line into /etc/rhn/rhn.conf and /etc/rhn/default/rhn_web.conf:


{{{
web.product_name = Spacewalk
}}}