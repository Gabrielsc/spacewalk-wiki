== Jabber and OSAD client connection issues ==

=== Symptoms ===

- Client connections aren't reconnecting if the connection is lost.

- A client's 'netstat -an |grep 5222' command saying "ESTABLISHED" even though there is no connection on the spacewalk server.

   -  Usually happens if there are firewalls with session timeout's


=== Symptom Description ===
We were seeing a 104 connections connected with local port 5222 (jabber) to our server, whenever we reboot it the connections dropped back to 3 (local connections). It seems that the client connections aren't reconnecting if the connection is lost.
Setting debug to 10 on the client showed nothing in the logs when it stops responding (nothing in "osa-dispatcher" log on server either). We noticed that on the client side that netstat shows an "ESTABLISHED" connection to the server whilst on the actual server it does not show any corresponding connection from the client.
We then found that our firewalls have session time-outs, thus the jabber connections were timing out. This also causes the strange behaviour of a clients 'netstat -an |grep 5222' command saying "ESTABLISHED" even though there is no connection on the spacewalk server.


=== Fix ===
After doing the following, we saw no further issues with time-outs.


The below jabber settings are all explained in the .xml configs under /etc/jabberd/.

Essentially, it will send a "whitespace" character as a keepalive. (Every 2 minutes with the below settings.)

This may be verified with tcpdump.

Of course depending on your firewall time-out settings, you may need to tweak this a bit.



==== On the spacewalk server ====


1. Set the timeout intervals for jabber daemon

{{{
sed -i 's/<interval>.*/<interval>120<\/interval>/' /etc/jabberd/*.xml*
sed -i 's/<keepalive>.*/<keepalive>120<\/keepalive>/' /etc/jabberd/*.xml*
sed -i 's/<idle>.*/<idle>200<\/idle>/' /etc/jabberd/*.xml*
}}}

2. Restart spacewalk
{{{
rhn-satellite restart
}}}

3. Create cronjob in root's crontab
{{{
/sbin/service jabberd stop ; /sbin/service osa-dispatcher stop ; rm -Rf /var/lib/jabberd/db/* ; /sbin/service jabberd start ; /sbin/service osa-dispatcher start
}}}





==== On spacewalk clients ====

1. Create cronjob in root's crontab that restarts osad every 4 hours or so.
(I also disable rhnsd to alleviate issues with that daemon not checking in.)
{{{
SAMPLE
# Check in with spacewalk and restart osad every ~4 hours
0 */3 * * *  sleep `expr ${RANDOM:0:4} / 2` ; /sbin/service osad restart ; /usr/sbin/rhn_check ; /usr/sbin/rhn-profile-sync
}}}

2. Restart OSAD on all clients.
{{{
/sbin/service osad restart
}}}




Hope this helps someone else.

-- Josh Mullis (CCI - Atlanta)