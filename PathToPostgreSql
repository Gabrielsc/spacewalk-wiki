= Introduction =

In light of the feedback we've received after open sourcing and a surprising number of volunteers in the community coming forward, we're pleased to begin gathering feedback and attempting to organize the effort to break Spacewalk's dependency on Oracle and add support for PostgreSQL.

While quite universally agreed that Oracle dependence must go and PostgreSQL is first on the list, there has been some debate on the spacewalk-devel mailing list on how to proceed with this. The main issue of contention is stored procedures and what should be done with them:

  1. Port them directly to PostgreSQL's PL/pgSQL. 
  1. Remove them one by one, migrating the code into the application layer.

Keep in mind that the situation is complicated by the fact that the stored procedures are currently accessed from all three languages that currently make up Spacewalk today. (Java, Python, Perl) 

The pros and cons of each approach will be discussed in the coming proposals. Please see [https://www.redhat.com/archives/spacewalk-devel/2008-June/thread.html#00015 this thread] for more information.

= Proposals = 

Key issue of contention here is stored procedures, and thus these proposals will focus on this issue. See the list of Tasks for aspects of this migration that will likely be required regardless which approach we choose.

== Proposal 1: Straightforward Port to PostgreSQL ==

Port the Oracle PL/SQL directly to PostgreSQL's PL/pgSQL.

 - Is there any plans to migrate off Oracle completely? - RahulSundaram
   - Not that I'm aware of. Oracle will likely remain an option for Satellite installations for some time. That said we may be able to reach a point where the Oracle specific code is abstracted enough that we could package it separately and remove it from Spacewalk and just maintain it internally at Red Hat. - DevanGoodwin
   - Correct.  We will continue to support external DB support (at the very least) for Oracle for our enterprise Satellite customers.  - ToddSanders  

Pros:

  * Likely to get us up and running on PostgreSQL faster. Oracle's PL/SQL and PostgreSQL's PL/pgSQL are reportedly quite similar. (see notes [http://www.pgadmin.org/docs/1.4/pg/plpgsql-porting.html here])
  * Potential performance gains.
  * Able to continue using database specific features.

Cons:

  * Now locked into two database's instead of just one. If we wish to support MySQL or SQLite in the future, we are in the same predicament we are today.
  * Maintenance cost involved with having all our stored procedure code duplicated for two database engines.
  * Significant debate on whether business logic should be done in the database in the first place.

== Proposal 2: Push Stored Procedures to Application Code ==

Remove the stored procedures one by one, replacing them with application code making heavy use of an ORM toolkit. Will have to expose these via some kind of RPC mechanism (cturner has floated the idea of [http://developers.facebook.com/thrift/ Thrift], a project released by Facebook, but other suggestions are welcome) so the respective languages can access them. If caught in a performance problem, can still use a stored procedure behind the scenes to do the lifting. 

Pros:

  * Much better prepared to support other database's in the future.
  * Increased ability to properly unit test.
  * Still able to fall back to a stored procedure call behind the scenes if necessary for a performance problem. (will need to plan for this accordingly)

Cons:

  * Any ORM library will have quirks, bugs, and require extra attention on occasion. For those used to working directly with SQL and all the features of whatever database engine they're working with, this can be even more frustrating.
  * Performance loss in some situations. How many, how severe, and what options are available to work around these remains to be seen.
  * Likely to take longer than a straightforward port.

= Tasks =

Please hold off on jumping into any of these just yet, or check in on spacewalk-devel before doing so. We hope to have our bearings for how the new spacewalk community would like to proceed shortly!

  1. Generate a PostgreSQL compatible schema.
    * [http://freshmeat.net/projects/ora2pg/ ora2pg] looks like a tool we can use to do this for us. Initial tests generated SQL that required only a few minor touchups. 
  1. Modify spacewalk-setup to support configuration of multiple database backends.
    * Should be done in a manner not reliant on "if oracle else if postgresql" type constructs, but rather plan ahead to actually support multiple backends should the need arise.
  1. Prepare our homegrown "Datasource" code to support *optionally* multiple versions of a query, specific to the underlying database.

Additional tasks will be added as we establish which direction we intend to take.

= Stored Procedures Analysis =

Total number of stored procedures to convert 36 functions + 17 procedures + 137 procedures in packages

Most expensive stored procedures to port from Oracle to PostgreSQL

|| Package Name || Procedure Name || Number of lines||
|| RPM || rpmstrcmp ||132 ||
|| RHN_ENTITLEMENTS || modify_org_service ||127 ||
|| RHN_CHANNEL || subscribe_server ||120 ||
|| RHN_ORG || delete_user ||119 ||
|| RHN_ENTITLEMENTS || repoll_virt_guest_entitlements ||109 ||
|| RHN_CHANNEL || unsubscribe_server ||100 ||
|| RHN_SERVER || insert_into_servergroup ||95 ||
|| RHN_SERVER || snapshot_server ||89 ||
|| RHN_ENTITLEMENTS || assign_system_entitlement ||85 ||
|| RHN_ENTITLEMENTS || prune_group ||81 ||
|| RHN_SERVER || delete_from_servergroup ||78 ||
|| RHN_CHANNEL || channel_priority ||77 ||
|| RHN_ENTITLEMENTS || remove_server_entitlement ||73 ||
|| RHN_USER || find_mailable_address ||71 ||
|| RHN_CONFIG || delete_revision ||70 ||
|| RHN_ENTITLEMENTS || set_family_count ||63 ||
|| RHN_SERVER || remove_action ||62 ||
|| RHN_ENTITLEMENTS || assign_channel_entitlement ||62 ||
|| RHN_ENTITLEMENTS || set_group_count ||58 ||
|| RHN_ENTITLEMENTS || prune_family ||56 ||
|| RHN_ENTITLEMENTS || entitle_server ||55 ||
|| RHN_ENTITLEMENTS || can_entitle_server ||55 ||
|| RHN_CONFIG_CHANNEL || get_user_chan_access ||53 ||
|| RHN_CONFIG_CHANNEL || action_diff_revision_status ||50 ||
|| RHN_ENTITLEMENTS || prune_everything ||50 ||
|| RHN_CHANNEL || bulk_server_basechange_from ||46 ||
|| RHN_CHANNEL || available_family_subscriptions ||46 ||
|| RHN_ORG || delete_org ||45 ||
|| RHN_CHANNEL || user_role_check_debug ||44 ||
|| RHN_ENTITLEMENTS || activate_system_entitlement ||41 ||
|| RHN_ENTITLEMENTS || unentitle_server ||41 ||
|| RHN_CHANNEL || base_channel_rel_archid ||40 ||
|| RHN_ENTITLEMENTS || activate_channel_entitlement ||40 ||
|| RHN_CHANNEL || delete_server_channels ||38 ||
|| RHN_SERVER || bulk_snapshot ||37 ||
|| RHN_ENTITLEMENTS || subscribe_newest_servers ||36 ||
|| RHN_ENTITLEMENTS || entitle_last_modified_servers ||36 ||
|| RHN_ENTITLEMENTS || remove_org_entitlements ||35 ||
|| RHN_SERVER || bulk_snapshot_tag ||31 ||
|| RPM || vercmp ||30 ||
|| RHN_CONFIG || insert_revision ||30 ||
|| RHN_ENTITLEMENTS || find_compatible_sg ||29 ||
|| RHN_CHANNEL || can_server_consume_virt_channl ||29 ||
|| RHN_CHANNEL || entitle_customer ||28 ||
|| RHN_CHANNEL || set_family_maxmembers ||27 ||
|| RHN_SERVER || check_user_access ||27 ||
|| RHN_CHANNEL || update_channel ||27 ||
|| RHN_ENTITLEMENTS || get_server_entitlement ||26 ||
|| RHN_SERVER || set_custom_value ||26 ||
|| RHN_ENTITLEMENTS || entitlement_grants_service ||26 ||
|| RHN_SERVER || insert_set_into_servergroup ||26 ||
|| RHN_SERVER || insert_into_servergroup_maybe ||25 ||
|| RHN_CONFIG || insert_channel ||25 ||
|| RHN_SERVER || can_server_consume_virt_slot ||25 ||
|| RHN_CHANNEL || bulk_guess_server_base_from ||25 ||
|| RHN_SERVER || tag_delete ||24 ||
|| RHN_QUOTA || recompute_org_quota_used ||24 ||
|| RHN_EXCEPTION || raise_exception ||24 ||
|| RHN_SERVER || delete_set_from_servergroup ||23 ||
|| RHN_CACHE || update_perms_for_server_group ||23 ||
|| RHN_CACHE || update_perms_for_user ||23 ||
|| RHN_CHANNEL || channel_family_current_members ||23 ||
|| RHN_ENTITLEMENTS || can_switch_base ||23 ||
|| RHN_USER || remove_from_usergroup ||23 ||
|| RHN_USER || add_servergroup_perm ||21 ||
|| RHN_SERVER || get_ip_address ||21 ||
|| RHN_CONFIG || insert_file ||20 ||
|| RHN_CHANNEL || bulk_guess_server_base ||20 ||
|| RHN_CHANNEL || get_org_access ||20 ||
|| RHN_CHANNEL || base_channel_for_release_arch ||20 ||
|| RHN_QUOTA || set_org_quota_total ||20 ||
|| RHN_ENTITLEMENTS || lookup_entitlement_group ||19 ||
|| RHN_CONFIG || delete_file ||19 ||
|| RHN_ENTITLEMENTS || create_entitlement_group ||19 ||
|| RHN_SERVER || bulk_set_custom_value ||19 ||
|| RHN_CHANNEL || direct_user_role_check ||19 ||
|| RHN_CHANNEL || org_channel_setting ||19 ||
|| RHN_USER || check_role_implied ||18 ||
|| RHN_USER || check_role ||18 ||
|| RHN_USER || remove_servergroup_perm ||18 ||
|| RHN_CONFIG_CHANNEL || get_user_revision_access ||18 ||
|| RHN_USER || add_to_usergroup ||18 ||
|| RHN_CHANNEL || guess_server_base ||17 ||
|| RHN_DATE_MANIP || get_reporting_period_end ||17 ||
|| RHN_CHANNEL || refresh_newest_package ||17 ||
|| RHN_CHANNEL || license_consent ||17 ||
|| RHN_DATE_MANIP || get_reporting_period_start ||17 ||
|| RHN_CHANNEL || get_license_path ||16 ||
|| RHN_CHANNEL || clear_subscriptions ||16 ||
|| RHN_CONFIG_CHANNEL || get_user_file_access ||16 ||
|| RHN_PACKAGE || channel_occupancy_string ||16 ||
|| RHN_SERVER || system_service_level ||16 ||
|| RHN_PACKAGE || canonical_name ||15 ||
|| RHN_EXCEPTION || lookup_exception ||15 ||
|| RHN_SERVER || can_change_base_channel ||15 ||
|| RHN_CHANNEL || user_role_check ||15 ||
|| RHN_QUOTA || get_org_for_config_content ||14 ||
|| RHN_CHANNEL || family_for_channel ||14 ||
|| RHN_CHANNEL || normalize_server_arch ||14 ||
|| RHN_CHANNEL || get_cfam_org_access ||14 ||
|| RHN_SERVER || delete_from_org_servergroups ||14 ||
|| RHN_CONFIG || get_latest_revision ||13 ||
|| RHN_USER || add_users_to_usergroups ||13 ||
|| RHN_USER || remove_users_from_servergroups ||13 ||
|| RHN_EXCEPTION || raise_exception_val ||12 ||
|| RHN_CHANNEL || available_chan_subscriptions ||12 ||
|| RHN_CONFIG || delete_channel ||12 ||
|| RHN_SERVER || clear_servergroup ||11 ||
|| RHN_CHANNEL || unsubscribe_server_from_family ||11 ||
|| RHN_CHANNEL || update_channels_by_package ||11 ||
|| RHN_CHANNEL || update_channels_by_errata ||11 ||
|| RPM || isalphanum ||11 ||
|| RHN_CHANNEL || bulk_server_base_change ||11 ||
|| RPM || isalpha ||10 ||
|| RHN_SERVER || tag_snapshot ||10 ||
|| RHN_BEL || lookup_email_state ||10 ||
|| RHN_BEL || is_org_paid ||10 ||
|| RHN_ORG || find_server_group_by_type ||10 ||
|| RHN_CACHE || update_perms_for_server ||10 ||
|| RHN_CHANNEL || update_family_counts ||10 ||
|| RHN_CHANNEL || get_org_id ||9 ||
|| RHN_USER || get_org_id ||9 ||
|| RPM || isdigit ||9 ||
|| RHN_CHANNEL || loose_user_role_check ||8 ||
|| RPM || vercmpResetCounter ||8 ||
|| RHN_QUOTA || update_org_quota ||7 ||
|| RHN_CHANNEL || bulk_unsubscribe_server ||7 ||
|| RHN_CHANNEL || bulk_subscribe_server ||7 ||
|| RHN_CONFIG || prune_org_configs ||6 ||
|| RHN_ENTITLEMENTS || unset_customer_monitoring ||5 ||
|| RHN_ENTITLEMENTS || unset_customer_enterprise ||5 ||
|| RHN_ENTITLEMENTS || set_customer_nonlinux ||5 ||
|| RHN_ENTITLEMENTS || set_customer_provisioning ||5 ||
|| RHN_ENTITLEMENTS || unset_customer_nonlinux ||5 ||
|| RPM || vercmpCounter ||5 ||
|| RHN_ENTITLEMENTS || set_customer_monitoring ||5 ||
|| RHN_ENTITLEMENTS || set_customer_enterprise ||5 ||
|| RHN_ENTITLEMENTS || unset_customer_provisioning ||5 ||


== Stored procs used in Perl ==
||XXRH_OAI_WRAPPER.sync_address||
||XXRH_OAI_WRAPPER.sync_contact||
||XXRH_OAI_WRAPPER.sync_customer||
||dbms_utility.db_version||
||evr.as_vre_simple||
||rhn_bel.is_org_paid||
||rhn_channel.available_chan_subscriptions||
||rhn_channel.channel_priority||
||rhn_channel.get_license_path||
||rhn_channel.guess_server_base||
||rhn_channel.license_consent||
||rhn_channel.org_channel_setting||
||rhn_channel.refresh_newest_package||
||rhn_channel.update_channel||
||rhn_channel.user_role_check||
||rhn_config.delete_channel||
||rhn_config.delete_file||
||rhn_config.insert_channel||
||rhn_config_channel.action_diff_revision_status||
||rhn_config_channel.get_user_chan_access||
||rhn_config_channel.get_user_file_access||
||rhn_entitlements.can_entitle_server||
||rhn_entitlements.can_switch_base||
||rhn_entitlements.remove_server_entitlement||
||rhn_ep.entitlement_queue_pending||
||rhn_ep.process_queue_batch||
||rhn_org.delete_user||
||rhn_server.bulk_set_custom_value||
||rhn_server.bulk_snapshot||
||rhn_server.bulk_snapshot_tag||
||rhn_server.delete_set_from_servergroup||
||rhn_server.remove_action||
||rhn_server.set_custom_value||
||rhn_server.snapshot_server||
||rhn_server.system_service_level||
||rhn_server.tag_snapshot||
||rhn_user.add_to_usergroup||
||rhn_user.add_users_to_usergroups||
||rhn_user.delete_from_usergroup||
||rhn_user.remove_from_usergroup||
||rhn_user.remove_users_from_servergroups||
||rhn_user.remove_users_from_usergroups||
||rpm.vercmp||



== Stored Procs used in Java ==

||rhn.delete_channel||
||rhn_cache.update_perms_for_server||
||rhn_cache.update_perms_for_user||
||rhn_channel.available_chan_subscriptions||
||rhn_channel.channel_priority||
||rhn_channel.get_license_path||
||rhn_channel.get_org_access||
||rhn_channel.guess_server_base||
||rhn_channel.loose_user_role_check||
||rhn_channel.org_channel_setting||
||rhn_channel.refresh_newest_package||
||rhn_channel.subscribe_server||
||rhn_channel.unsubscribe_server||
||rhn_channel.update_channel||
||rhn_channel.user_role_check||
||rhn_channel.user_role_check_debug||
||rhn_config.delete_channel||
||rhn_config.delete_file||
||rhn_config.delete_revision||
||rhn_config.insert_channel||
||rhn_config.insert_file||
||rhn_config.insert_revision||
||rhn_config_channel.get_user_chan_access||
||rhn_config_channel.get_user_file_access||
||rhn_config_channel.get_user_revision_access||
||rhn_entitlements.assign_channel_entitlement||
||rhn_entitlements.assign_system_entitlement||
||rhn_entitlements.can_entitle_server||
||rhn_entitlements.entitle_server||
||rhn_entitlements.remove_server_entitlement||
||rhn_entitlements.unentitle_server||
||rhn_ep.poll_customer_internal||
||rhn_ep.process_queue_batch||
||rhn_org.delete_org||
||rhn_org.delete_user||
||rhn_server.delete_from_servergroup||
||rhn_server.insert_into_servergroup_maybe||
||rhn_server.remove_action||
||rhn_server.snapshot_server||
||rhn_server.system_service_level||
||rhn_user.add_servergroup_perm||
||rhn_user.add_to_usergroup||
||rhn_user.check_role||
||rhn_user.remove_from_usergroup||
||rhn_user.remove_servergroup_perm||
||rpm.vercmp||
||web_disable_user_pkg.disable_user||
||web_disable_user_pkg.reenable_user||
||xxrh_oai_wrapper.sync_contact||
||xxrh_oai_wrapper.sync_customer||



= Logistics =

  1. Development may need to take place in a branch to prevent de-stabilizing master too much. Will cross this bridge when we come to it.


= Links =

  * [http://www.pgadmin.org/ pgAdmin]: Looks like an exceptional GUI tool for Postgresql management.
  * http://www.pgadmin.org/docs/1.4/pg/plpgsql-porting.html: Some notes on migrating Oracle PL/SQL to PL/pgSQL.
  * [http://freshmeat.net/projects/ora2pg/ ora2pg]: Migration tool.
