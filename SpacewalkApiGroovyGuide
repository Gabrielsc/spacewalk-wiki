= The Groovy Coders’ Guide to the Red Hat Network Satellite/Spacewalk API =

== Intended Audience ==

The document is intended for system administrators and/or Groovy coders who wish to make use of the RedHat RHN Satellite v5.1 Server API. There may well be better ways to code the examples below and it should be noted that they have not been thoroughly examined for security issues.

== API Introduction ==

Every Groovy script that accesses the Satellite API must include some variation on the following code:

{{{
import groovy.net.xmlrpc.*

// Set the host appropriately
def host = "satellite.company.com"

def url = "http://${host}/rpc/api"
def client = new XMLRPCServerProxy(url)

// Use the client to obtain the authentication key
def key = client.auth.login(username, password)

assert client != null && key != null  : "Login to RHN Satellite failed!"
}}}

The problem with the above approach is the username and password of a valid (and probably privileged) Satellite user is stored in clear text in each and every one of your scripts. To avoid this, I create the file /etc/satellite_api.conf (which a filemode of 0600 and owned by root:root) which contains:

{{{
satellite.company.com user password
}}}

and use a home grown Groovy class called RHNSession. RHNSession consists of:

{{{
import groovy.net.xmlrpc.*

class RHNSession {

    def configFile = "/etc/satellite_api.conf"

    def client
    def key

    def isLoggedIn() {
        client != null && key != null
    }

    def login() {
        def config = new File(configFile)
        assert config.exists() : "Failed reading ${configFile} because it doesn't exist"

        def (hostname, username, password) = config.readLines()[0].split(" ")

        client = new XMLRPCServerProxy("http://${hostname}/rpc/api")
        key = client.auth.login(username, password)

        assert isLoggedIn() : "Failed logging into ${hostname} as ${username}"
    }

    def logout() {
        assert isLoggedIn() : "Not logged into Satellite"
        assert client.auth.logout(key) == 1 : "Failed logging out of Satellite"
        client = null
        key = null
    }

}
}}}

So your minimal API Groovy script is now:

{{{
RHNSession rhn = new RHNSession()
rhn.login()

def apiNamespaces = rhn.client.api.getApiNamespaces(rhn.key)
apiNamespaces.each { apiNamespace ->
    println apiNamespace
}

rhn.logout()
}}}

== API Insights ==


=== Troubleshooting ===

Like Satellite itself, the API is not trivial and can take some time to get your head around. It’s very difficult to understand why your code isn’t working as expected if:

* You can’t visualise the data you are working with
* You don’t know how the module you are using is designed to work.

== Sources ==

* Groovy XMLRPC Module (http://groovy.codehaus.org/XMLRPC)
* RedHat Satellite mailing list (https://www.redhat.com/mailman/listinfo/rhn-satellite-users)
* Documentation on the Satellite Server: (https://satellite.example.com/rhn/apidoc/index.jsp)
